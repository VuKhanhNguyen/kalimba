
MyKalimba - Database schema (proposed)
Date: 2026-01-21

Scope (current planned features):
- User registration / login
- Manage song entries and kalimba tabs (tablature)

--------------------------------------------------------------------------------
1) Logical tables & columns
--------------------------------------------------------------------------------

TABLE: users
- id
- email (unique)
- password_hash
- display_name
- created_at
- updated_at

TABLE: user_sessions (optional but recommended if using refresh tokens)
- id
- user_id (FK -> users.id)
- refresh_token_hash
- expires_at
- created_at
- revoked_at

TABLE: songs
- id
- title
- artist (nullable)
- created_by (FK -> users.id)
- is_public
- created_at
- updated_at

TABLE: tabs
- id
- song_id (FK -> songs.id)
- created_by (FK -> users.id)
- instrument (default: kalimba)
- format (text/json/kmb...)
- content (TEXT/JSON)
- base_note (nullable)         -- matches your app's baseNote slider concept
- keys_count (nullable)        -- 8..21
- arrangement (nullable)       -- Ascending/Alternating/Descending
- label_type (nullable)        -- Number/Letter/Letter_number
- soundfont (nullable)         -- Keylimba/FluidR3_GM/FatBoy
- version
- created_at
- updated_at

Notes:
- You can skip user_sessions if you only use short-lived JWT access tokens without refresh.
- content can be TEXT (store plain tablature) or JSON (store structured events/notes).

--------------------------------------------------------------------------------
2) SQL DDL - PostgreSQL (recommended)
--------------------------------------------------------------------------------

-- Enable UUID generation (Postgres 13+)
-- Option A: pgcrypto
CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE IF NOT EXISTS users (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	email TEXT NOT NULL UNIQUE,
	password_hash TEXT NOT NULL,
	display_name TEXT,
	created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
	updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS user_sessions (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
	refresh_token_hash TEXT NOT NULL,
	expires_at TIMESTAMPTZ NOT NULL,
	created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
	revoked_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_user_sessions_expires_at ON user_sessions(expires_at);

CREATE TABLE IF NOT EXISTS songs (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	title TEXT NOT NULL,
	artist TEXT,
	created_by UUID REFERENCES users(id) ON DELETE SET NULL,
	is_public BOOLEAN NOT NULL DEFAULT TRUE,
	created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
	updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_songs_created_by ON songs(created_by);
CREATE INDEX IF NOT EXISTS idx_songs_is_public ON songs(is_public);

CREATE TABLE IF NOT EXISTS tabs (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	song_id UUID NOT NULL REFERENCES songs(id) ON DELETE CASCADE,
	created_by UUID REFERENCES users(id) ON DELETE SET NULL,
	instrument TEXT NOT NULL DEFAULT 'kalimba',
	format TEXT NOT NULL DEFAULT 'text',
	content TEXT NOT NULL,
	base_note INTEGER,
	keys_count INTEGER,
	arrangement TEXT,
	label_type TEXT,
	soundfont TEXT,
	version INTEGER NOT NULL DEFAULT 1,
	created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
	updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_tabs_song_id ON tabs(song_id);
CREATE INDEX IF NOT EXISTS idx_tabs_created_by ON tabs(created_by);

--------------------------------------------------------------------------------
3) SQL DDL - SQLite (simple local dev)
--------------------------------------------------------------------------------

-- SQLite does not have native UUID; you can use TEXT ids, or INTEGER ids.
-- Below uses INTEGER ids for simplicity.

CREATE TABLE IF NOT EXISTS users (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	email TEXT NOT NULL UNIQUE,
	password_hash TEXT NOT NULL,
	display_name TEXT,
	created_at TEXT NOT NULL DEFAULT (datetime('now')),
	updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS user_sessions (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	user_id INTEGER NOT NULL,
	refresh_token_hash TEXT NOT NULL,
	expires_at TEXT NOT NULL,
	created_at TEXT NOT NULL DEFAULT (datetime('now')),
	revoked_at TEXT,
	FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_user_sessions_expires_at ON user_sessions(expires_at);

CREATE TABLE IF NOT EXISTS songs (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	title TEXT NOT NULL,
	artist TEXT,
	created_by INTEGER,
	is_public INTEGER NOT NULL DEFAULT 1,
	created_at TEXT NOT NULL DEFAULT (datetime('now')),
	updated_at TEXT NOT NULL DEFAULT (datetime('now')),
	FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
);

CREATE INDEX IF NOT EXISTS idx_songs_created_by ON songs(created_by);
CREATE INDEX IF NOT EXISTS idx_songs_is_public ON songs(is_public);

CREATE TABLE IF NOT EXISTS tabs (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	song_id INTEGER NOT NULL,
	created_by INTEGER,
	instrument TEXT NOT NULL DEFAULT 'kalimba',
	format TEXT NOT NULL DEFAULT 'text',
	content TEXT NOT NULL,
	base_note INTEGER,
	keys_count INTEGER,
	arrangement TEXT,
	label_type TEXT,
	soundfont TEXT,
	version INTEGER NOT NULL DEFAULT 1,
	created_at TEXT NOT NULL DEFAULT (datetime('now')),
	updated_at TEXT NOT NULL DEFAULT (datetime('now')),
	FOREIGN KEY (song_id) REFERENCES songs(id) ON DELETE CASCADE,
	FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
);

CREATE INDEX IF NOT EXISTS idx_tabs_song_id ON tabs(song_id);
CREATE INDEX IF NOT EXISTS idx_tabs_created_by ON tabs(created_by);

--------------------------------------------------------------------------------
4) Suggested API mapping (for later)
--------------------------------------------------------------------------------
Auth:
- POST /api/auth/register -> users
- POST /api/auth/login    -> users + user_sessions

Songs:
- GET/POST /api/songs
- GET/PUT/DELETE /api/songs/:id

Tabs:
- GET/POST /api/songs/:songId/tabs
- GET/PUT/DELETE /api/tabs/:id

